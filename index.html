<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barbelopp</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Barbelopp">

  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f6f7; }
    .card { background: white; border-radius: 14px; padding: 14px; box-shadow: 0 1px 8px rgba(0,0,0,.06); margin-bottom: 12px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    label { display:block; font-size: 13px; color: #555; margin: 10px 0 6px; }
    input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
    button { width: 100%; padding: 12px; border: 0; border-radius: 12px; font-size: 16px; }
    .primary { background: #111; color: #fff; }
    .secondary { background: #e9e9ec; color: #111; margin-top: 8px; }
    .danger { background: #ffe5e5; color: #7a0000; margin-top: 8px; }
    .muted { color: #666; font-size: 13px; }
    .total { display:flex; justify-content: space-between; align-items: baseline; font-size: 16px; }
    .total strong { font-size: 18px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 6px; border-bottom: 1px solid #eee; text-align: left; }
    th { font-size: 13px; color: #555; }
    td:last-child, th:last-child { text-align: right; }
    .small { font-size: 12px; color: #666; }
  </style>
</head>
<body>

  <div class="card">
    <h1>Barbelopp</h1>
    <div class="muted">Sparar lokalt på enheten.</div>

    <label>Datum</label>
    <input id="date" type="date" />

    <label>Belopp (kr)</label>
    <input id="amount" inputmode="decimal" placeholder="t.ex. 1450" />

    <div style="height:10px"></div>
    <button class="primary" id="addBtn">Spara dagens belopp</button>
    <button class="secondary" id="exportBtn">Exportera CSV</button>
    <button class="danger" id="resetBtn">Nollställ allt</button>
  </div>

  <div class="card">
    <div class="total">
      <span>Total</span>
      <strong id="total">0 kr</strong>
    </div>
  </div>

  <div class="card">
    <div class="muted" style="margin-bottom:8px">Historik</div>
    <table>
      <thead>
        <tr><th>Datum</th><th>Belopp</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="small" style="margin-top:8px">Tryck på en rad för att ta bort den.</div>
  </div>

<script>
  const KEY = "barbelopp.entries.v1";

  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function load() {
    try { return JSON.parse(localStorage.getItem(KEY)) ?? []; }
    catch { return []; }
  }

  function save(entries) {
    localStorage.setItem(KEY, JSON.stringify(entries));
  }

  function parseAmount(s) {
    if (!s) return null;
    const cleaned = String(s).trim().replace(/\s+/g, "").replace(",", ".");
    if (!/^\d+(\.\d{1,2})?$/.test(cleaned)) return null;
    return Number(cleaned);
  }

  function formatSEK(n) {
    return new Intl.NumberFormat("sv-SE", { maximumFractionDigits: 2 }).format(n);
  }

  function render() {
    const entries = load().sort((a,b) => (a.date < b.date ? 1 : -1));
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    let total = 0;
    for (const e of entries) total += e.amount;
    document.getElementById("total").textContent = formatSEK(total) + " kr";

    for (const e of entries) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${e.date}</td><td>${formatSEK(e.amount)} kr</td>`;
      tr.style.cursor = "pointer";
      tr.addEventListener("click", () => {
        if (!confirm(`Ta bort ${e.date} – ${formatSEK(e.amount)} kr?`)) return;
        const filtered = load().filter(x => x.id !== e.id);
        save(filtered);
        render();
      });
      tbody.appendChild(tr);
    }
  }

  document.getElementById("date").value = todayISO();
  render();

  document.getElementById("addBtn").addEventListener("click", () => {
    const date = document.getElementById("date").value || todayISO();
    const amount = parseAmount(document.getElementById("amount").value);
    if (amount === null) {
      alert("Skriv ett giltigt belopp, t.ex. 1450 eller 1450,50.");
      return;
    }
    const entries = load();
    entries.push({ id: crypto.randomUUID(), date, amount });
    save(entries);
    document.getElementById("amount").value = "";
    document.getElementById("date").value = todayISO();
    render();
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const entries = load().sort((a,b) => (a.date > b.date ? 1 : -1));
    const lines = ["datum,belopp"];
    for (const e of entries) lines.push(`${e.date},${String(e.amount).replace(".", ",")}`);
    const csv = lines.join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "barbelopp.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    if (!confirm("Nollställa ALL historik?")) return;
    localStorage.removeItem(KEY);
    render();
  });
</script>

</body>
</html>
